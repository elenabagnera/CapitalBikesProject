---
title: "Exploratory Data Analysis (EDA)"
author: ""
date: ""
output: html_document
---

```{r include = FALSE}
def.chunk.hook <- knitr::knit_hooks$get("chunk")
knitr::opts_chunk$set(cache = FALSE)
knitr::knit_hooks$set(
  chunk = function(x, options) {
    x <- def.chunk.hook(x, options)
    ifelse(options$size != "normalsize", paste0("\n \\", options$size, "\n\n", x, "\n\n \\normalsize"), x)
  }
)
# knitr::knit_hooks$set(inline = function(x) {
#   prettyNum(round(x, 2), big.mark = ",")
# })
options(scipen = 999)
```

\begin{center}
\Huge{PPOL 670 | Final Project}

\Huge{Visualizations}
\end{center}

\vspace{0.1in}

[GitHub](https://github.com/elenabagnera/CapitalBikesProject)

```{r setup, include=FALSE}

library(tidyverse)
library(httr)
library(jsonlite)
source("times.R")
source("io.R")
source("manipulate_data.R")
library(tidymodels)
library(corrplot)
library(suncalc)
library(lubridate)
library(prophet)
```


```{r get historical data, warning = FALSE, message = FALSE}

# load generated data
hour_data <- read_csv("hour_data.csv")

# The grouped data does not have the original date column, but it can be nice for visualizations. There is a function to do this in times.R
hour_data_date <- add_date_column(hour_data)
```

## Splitting the data into training and testing

We are performing exploratory data analysis on the training data only.

```{r split}
set.seed(28021995)

# create a split object
data_split <- initial_split(hour_data_date, prop = 0.8)

# create the training and testing data
train_data_date <- training(x = data_split)
test_data_date  <- testing(x = data_split)
```

## Summary stats

```{r stats_dependent}
# summary entire train dataset
summary(train_data_date)

# summary lincoln_memorial_departures
train_data_date %>%
  summarize(
    mean(lincoln_memorial_departures),
    max(lincoln_memorial_departures),
    min(lincoln_memorial_departures),
    sd(lincoln_memorial_departures)) 
# how can we get better summary stats? maybe not split by hour?
# we can group the data, and sum if we need to

```


```{r stats_weather}
# check how much NA in temperature variable
# sum(is.na(train_data_date$temperature)) #0
# sum(is.na(train_data_date$cloud_cover)) #0

train_data_date %>%
 # mutate(weekday = wday(date, label=TRUE)) %>%
  group_by(month) %>%
  summarize(mean(temperature), max(temperature), min(temperature), sd(temperature)) 
```

```{r ride density}

# density plot (no log)
train_data_date %>%
  filter(lincoln_memorial_departures != 0) %>% # notice that we here are dropping 0s
  ggplot(aes(x = lincoln_memorial_departures)) +
  geom_density() +
  theme_minimal() +
  labs(title = "xxx", 
       x = "Number of departures from Lincoln Memorial")
# What does the number 50 entail?

# density plot (log)
train_data_date %>%
  filter(lincoln_memorial_departures != 0) %>% # notice that we here are dropping 0s
  ggplot(aes(x = log(lincoln_memorial_departures))) + # add log to fix skewness
  geom_density() +
  theme_minimal() +
  labs(title = "xxx", 
       x = "Number of departures from Lincoln Memorial (logged)")
# What does the number 4 entail?
```

## Visualizations by time at Lincoln Memorial
In this part, we use Lincoln Memorial as an example to show the change in amount of rides over time.

```{r date}
train_data_date %>%  # for me here there is a weird gap after July 2020, not sure why?
  ggplot(aes(x = date, y = lincoln_memorial_departures)) +
  geom_point(alpha = 0.1, color = "orange") + 
  geom_smooth() +
  labs(title = "January has the least demand of capital bikes",
       x = "Date", 
       y = "The Number of Departures at Lincoln Memorial")
```

```{r weekday, warning = FALSE}
# by weekday
train_data_date %>% 
  mutate(weekday = wday(date, label=TRUE)) %>% 
  ggplot(aes(x = weekday, y = lincoln_memorial_departures)) +
  geom_point(alpha = 0.1) + # clearly people cycle more on Saturdays and Sundays
  geom_smooth() +
  labs(title = "At Lincoln Memorial, Capitals bikes are mostly used for recreational purpose",
       subtitle = "Weekend has the highest demand",
       x = "Weekday (Aggregate)", 
       y = "The Number of Departures at Lincoln Memorial")

# farah's code here although similar to first one here?
#hour_data_date %>%
  #mutate(weekday = wday(date, label=TRUE)) %>%
  #ggplot(aes(x = weekday, y = lincoln_memorial)) +
  #geom_point(alpha = 0.25) +
  #labs(title = "Capital bikeshare Ridership on Week days") +
  #theme_minimal()
```

```{r day of month, warning = FALSE}
# by day of the month
train_data_date %>% 
  ggplot(aes(x = day, y = lincoln_memorial_departures)) +
  geom_point(alpha = 0.1, color = "salmon") + # there is no clear pattern across days of the month - aka probably not a good predictor
  geom_smooth() + 
  facet_wrap(~month, scales = "free_y") +
  labs(title = "At Lincoln Memorial, demand for bikes is more fluctuated in tourist season",
       x = "Day of a month", 
       y = "The Number of Departures at Lincoln Memorial")
```

```{r hour}
# by hour
train_data_date %>%
  ggplot(aes(x = factor(hour), y = lincoln_memorial_departures)) +
  geom_col(fill = "deepskyblue2", alpha = 0.8) +
  geom_smooth() +
  theme_minimal() +
  labs(title = "At Lincoln Memorial, bikes are most demanded in the afternoon from 12pm-6pm",
       subtitle = "The highest demand occurs at 2pm",
       x = "Hour (Aggregate)", 
       y = "The Number of Departures at Lincoln Memorial")
```

```{r specific day}
# for a specific month and day, seeing variance by hour
train_data_date %>% 
  filter(year == 2021, month == "Aug", day == 15) %>% 
  ggplot(aes(x = factor(hour), y = lincoln_memorial_departures)) +
  geom_col(fill = "Red", alpha = 0.5) + 
  theme_minimal() +
  labs(title = "On Aug 15, the highest demand occured at 12pm and 2pm",
       x = "Hour",
       y = "The Number of Departures at Lincoln Memorial")
```

```{r hour & month}
# by hour & month
train_data_date %>%
  ggplot(aes(x = hour, y = lincoln_memorial_departures)) +
  geom_point(alpha = 0.1, color = "dark green") + # people cycle more in the middle of the day, like between 1 and 7PM
  geom_smooth() +
  facet_wrap(~month)
```


```{r month}
# add month order
order_month <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

# by month
train_data_date %>% 
  ggplot(aes(x = month, y = lincoln_memorial_departures), level = order_month) +
  geom_point(alpha = 0.1, color = "dark red") + 
  scale_x_discrete(limits = month.abb) +
  # people cycle most in Spring, summer and fall. Surprised that there is no big spike in summer months
  geom_smooth() +
  theme_minimal() +
  labs(title = "At Lincoln Memorial, people cycle the most in Spring",
       x = "Month (Aggregate)",
       y = "The Number of Departures at Lincoln Memorial")
```

```{r year}
# by year
train_data_date %>% 
  ggplot(aes(x = factor(year), y = lincoln_memorial_departures)) +
  geom_col(width = 0.3, color = "pink") + 
  geom_smooth() +
  theme_minimal() +
  labs(title = "At Lincoln Memorial, more people use the bike in 2021 than in 2020",
       x = "Year (Aggregate)",
       y = "The Number of Departures at Lincoln Memorial")
```

```{r holidays}
#prep training data for holiday barchart - 1 year of data from May 2020 to April 2021
bar_date <- train_data_date %>%
  filter(year==2020 | year==2021 & month== "Jan" | year==2021 & month== "Feb"|year==2021 & month== "Mar"|year==2021 & month== "Apr") %>%
  group_by(day, month, year)%>%
  summarise(lincoln_memorial_departures=sum(lincoln_memorial_departures), n())
## confirmed: 365 days exist in this data frame but not everyday has 24 hours because the training data does not have the full data

# check for missing data
sum(is.na(bar_date$lincoln_memorial_departures)) #0

# what is the mean departures per day?
mean_day <- bar_date %>%
  group_by(day) %>%
  summarize(n= mean(lincoln_memorial_departures)) %>%
  summarize(mean(n))  ## mean per day is 55.6
              
# create a data frame for holidays
holidays <- generated_holidays %>%
  filter(country == "US") 

holidays$ds <- as_date(ymd(holidays$ds)) 

holidays <- holidays %>%
  mutate(
    day = day(ymd(ds)),
    month = month(ymd(ds), label = TRUE)
                     ) %>%
  filter(year==2020 | year==2021) 

holidays_date <- left_join(bar_date, holidays, by= c('year', 'month', 'day')) %>%
    na.omit(holidays) 

holidays_date %>%
  ggplot(aes(y= holiday, x= lincoln_memorial_departures , fill=lincoln_memorial_departures)) + 
  geom_col()+
  geom_vline(xintercept = 55.6, color="black")+ ## 66.6 is the mean ridership per day
  xlab("") +
  ylab("Number of departures") +
  scale_fill_gradient(low = "#FFFFFFFF",
                    high = "#012345") +
  #scale_fill_gradient2() +
 #scale_colour_discrete("Holidays")+
  #scale_fill_manual(c("#FF6666")) +
  labs(title = "", caption = "") +
  guides(fill=guide_legend(title="Number of departures")) +
  #theme_minimal() +
  theme(plot.caption = element_text(face = "italic")
  ) 

 ggsave("holidaybar.jpg", width = 50, height = 20, units = "cm")
```

## Visualizations by weather at Lincoln Memorial

In this part, we visualize the demand of bikes at the Lincoln Memorial station by different whether conditions.
```{r temperatures}
# weather viz
train_data_date %>%
  ggplot(aes(x = temperature, y = lincoln_memorial_departures))+
  geom_point(alpha = 0.1,color = "orange") +
  labs(x = 'Temperature', y = 'Hourly Departures and Arrivals')+
  geom_smooth() +
  theme_minimal() +
  labs(title = "As the temperature goes up, departure also goes up",
       subtitle = "There is a linear relationship between demand and temperature",
       x = "Temperature (Fahrenheit)",
       y = "Aggregate number of departures at Lincoln Memorial")
```

```{r temperatures_month, warning = FALSE}
# temperature in each month
train_data_date %>%
  ggplot(aes(x = temperature, y = lincoln_memorial_departures))+
  geom_point(alpha = 0.07, color = "orange") +
  geom_smooth() +
  facet_wrap(~month) +
  theme_light() +
  labs(title = "As the temperature goes up, demand for bikes also goes up",
       subtitle = "There is a rough linear relationship between temperature demand except August",
       x = "Temperature (Fahrenheit)",
       y = "Aggregate number of departures at Lincoln Memorial")
```


```{r wind, warning = FALSE}
# wind viz
train_data_date %>%
  ggplot(aes(x = wind_speed,y = lincoln_memorial_departures))+
  geom_point(alpha = 0.1,color = "deepskyblue2") +
  geom_smooth() + # data is sparse hence why we get this weird trend
  theme_minimal() +
  labs(title = "Demand for bikes is not sensitive to wind speed",
       subtitle = "No clear relationship is shown between wind speed and bike demand",
       x = "Wind Speed (miles per minute)",
       y = "Aggregate number of departures at Lincoln Memorial")
```

```{r rain, warning = FALSE}
# rain viz
train_data_date %>%
  filter(precipitation != 0) %>% 
  #removing 0 to better show relationship
  ggplot(aes(x = precipitation, y = lincoln_memorial_departures))+
  geom_point(alpha = 0.1,color = "blue") +
  geom_smooth() +
  theme_minimal() +
  labs(title = "Negative relationship between bike demand and precipitation",
       subtitle = "No clear relationship is shown between wind speed and bike demand",
       x = "Precipitation (include drizzling, rain, sleet, snow, ice pellets, graupel and hail)",
       y = "Aggregate number of departures at Lincoln Memorial")
# data very sparse hence why weird trend. Aaron recommended also creating a variable that dychotomizes rain. 1 if it rains 0 if it doesn't.
```


```{r clouds}
#cloud viz
train_data_date %>%
  ggplot(aes(x = cloud_cover,y = lincoln_memorial_departures)) +
  geom_point(alpha = 0.5, color = "lightblue") +
  geom_smooth() +
  theme_minimal() +
  labs(title = "Demand for bikes is not sensitive to cloud coverage",
       subtitle = "No clear relationship is shown between cloud and bike demand",
       x = "Cloud Cover",
       y = "Aggregate number of departures at Lincoln Memorial")
```
```{r sunlight}
#sunlight
train_data_date %>%
  ggplot(aes(x = factor(sun_is_out), y = lincoln_memorial_departures)) +
  geom_col(color = "lightgoldenrod1", width = 0.3) +
  geom_smooth() +
  theme_bw() +
  facet_wrap(~month) +
  labs(title = "Passengers have high preference to ride bikes during daytime",
       subtitle = "While in cold seasons, the gap in demand shrinks drastically",
       x = "Sunlight (sun is out = 1, otherwise = 0)",
       y = "Aggregate number of departures at Lincoln Memorial")
```

```{r heatmap}
library(reshape2)

heatmap <- train_data_date %>%
  select (hour, lincoln_memorial_departures)  %>%
    group_by (hour) %>%
  summarize (sum_rider =sum(lincoln_memorial_departures))

#reshape data
data_melt <- melt(heatmap, id= "hour")

# plot the graph  
data_melt %>%
 ggplot(aes(hour, variable)) +
    geom_tile(aes(fill = value)) +
    labs(x = NULL,
         y = NULL) + 
  scale_fill_gradientn(colors = "blue") +
 #scale_fill_gradientn(colours = rainbow(10)) +
 #scale_fill_gradient(low = "white", mid = "blue", high = "black")+
  scale_fill_gradient(low = "#FFFFFFFF",
                    high = "#012345")  +
    theme(legend.position = "right",
          legend.direction = "vertical",
          axis.line.x = element_blank(),
          panel.grid.major.y = element_blank()) 
```
